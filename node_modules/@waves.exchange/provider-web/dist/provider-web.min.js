!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).providerWeb={})}(this,(function(e){"use strict";var t="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function n(e){var t={exports:{}};return e(t,t.exports),t.exports}var o=function(e){return Object.keys(e)},r=Math.floor(Date.now()*Math.random()),i=0;var s=function(e){return e+"-"+r+"-"+i++};var a=function(e){return Array.isArray(e)?e:[e]};var c=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return function(t){return e.reduce((function(e,t){return t(e)}),t)}},u=Object.defineProperty({keys:o,uniqueId:s,toArray:a,pipe:c},"__esModule",{value:!0}),h=n((function(e,t){var n,o;Object.defineProperty(t,"__esModule",{value:!0}),n=t.config||(t.config={}),(o=n.console||(n.console={})).LOG_LEVEL={PRODUCTION:0,ERRORS:1,VERBOSE:2},o.logLevel=o.LOG_LEVEL.PRODUCTION,o.methodsData={log:{save:!1,logLevel:o.LOG_LEVEL.VERBOSE},info:{save:!1,logLevel:o.LOG_LEVEL.VERBOSE},warn:{save:!1,logLevel:o.LOG_LEVEL.VERBOSE},error:{save:!0,logLevel:o.LOG_LEVEL.ERRORS}}})),l=t&&t.__assign||function(){return(l=Object.assign||function(e){for(var t,n=1,o=arguments.length;n<o;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)},d=("undefined"!=typeof self?self:t).console,f=Object.create(null);function p(e){f[e]||(f[e]=[])}function _(e,t){f[e].push(t)}var v,y=l({},u.keys(h.config.console.methodsData).reduce((function(e,t){return e[t]=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];h.config.console.logLevel<h.config.console.methodsData[t].logLevel?h.config.console.methodsData[t].save&&(p(t),_(t,e)):d[t].apply(d,e)},e}),Object.create(null)),{getSavedMessages:function(e){return f[e]||[]}}),g=Object.defineProperty({console:y},"__esModule",{value:!0}),m=function(){function e(e){this.size=0,this.hash=Object.create(null),e&&e.forEach(this.add,this)}return e.prototype.add=function(e){return this.hash[e]=!0,this.size=Object.keys(this.hash).length,this},e.prototype.has=function(e){return e in this.hash},e.prototype.toArray=function(){return Object.keys(this.hash)},e}(),w=Object.defineProperty({UniqPrimitiveCollection:m},"__esModule",{value:!0}),E=n((function(e,t){function n(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}Object.defineProperty(t,"__esModule",{value:!0}),n(u),n(g),n(w)})),b=n((function(e,t){var n,o;Object.defineProperty(t,"__esModule",{value:!0}),(n=t.EventType||(t.EventType={}))[n.Event=0]="Event",n[n.Action=1]="Action",n[n.Response=2]="Response",(o=t.ResponseStatus||(t.ResponseStatus={}))[o.Success=0]="Success",o[o.Error=1]="Error";var r=function(){function e(e,t){var n=this;this.id=E.uniqueId("bus"),this._timeout=t||5e3,this._adapter=e,this._adapter.addListener((function(e){return n._onMessage(e)})),this._eventHandlers=Object.create(null),this._activeRequestHash=Object.create(null),this._requestHandlers=Object.create(null),E.console.info('Create Bus with id "'+this.id+'"')}return e.prototype.dispatchEvent=function(t,n){return this._adapter.send(e._createEvent(t,n)),E.console.info('Dispatch event "'+t+'"',n),this},e.prototype.request=function(e,t,n){var o=this;return new Promise((function(r,i){var s,a=E.uniqueId(o.id+"-action"),c=n||o._timeout;-1!==(n||o._timeout)&&(s=setTimeout((function(){delete o._activeRequestHash[a];var t=new Error('Timeout error for request with name "'+e+'" and timeout '+c+"!");E.console.error(t),i(t)}),c));var u=function(){s&&clearTimeout(s)};o._activeRequestHash[a]={reject:function(t){u(),E.console.error('Error request with name "'+e+'"',t),i(t)},resolve:function(t){u(),E.console.info('Request with name "'+e+'" success resolved!',t),r(t)}},o._adapter.send({id:a,type:1,name:e,data:t}),E.console.info('Request with name "'+e+'"',t)}))},e.prototype.on=function(e,t,n){return this._addEventHandler(e,t,n,!1)},e.prototype.once=function(e,t,n){return this._addEventHandler(e,t,n,!0)},e.prototype.off=function(e,t){var n=this;return e?this._eventHandlers[e]?t?(this._eventHandlers[e]=this._eventHandlers[e].filter((function(e){return e.handler!==t})),this._eventHandlers[e].length||delete this._eventHandlers[e],this):(this._eventHandlers[e].slice().forEach((function(t){n.off(e,t.handler)})),this):this:(Object.keys(this._eventHandlers).forEach((function(e){return n.off(e,t)})),this)},e.prototype.registerRequestHandler=function(e,t){if(this._requestHandlers[e])throw new Error("Duplicate request handler!");return this._requestHandlers[e]=t,this},e.prototype.unregisterHandler=function(e){return this._requestHandlers[e]&&delete this._requestHandlers[e],this},e.prototype.changeAdapter=function(t){var n=this,o=new e(t,this._timeout);return Object.keys(this._eventHandlers).forEach((function(e){n._eventHandlers[e].forEach((function(t){t.once?o.once(e,t.handler,t.context):o.on(e,t.handler,t.context)}))})),Object.keys(this._requestHandlers).forEach((function(e){o.registerRequestHandler(e,n._requestHandlers[e])})),o},e.prototype.destroy=function(){E.console.info("Destroy Bus"),this.off(),this._adapter.destroy()},e.prototype._addEventHandler=function(e,t,n,o){return this._eventHandlers[e]||(this._eventHandlers[e]=[]),this._eventHandlers[e].push({handler:t,once:o,context:n}),this},e.prototype._onMessage=function(e){switch(e.type){case 0:E.console.info('Has event with name "'+String(e.name)+'"',e.data),this._fireEvent(String(e.name),e.data);break;case 1:E.console.info('Start action with id "'+e.id+'" and name "'+String(e.name)+'"',e.data),this._createResponse(e);break;case 2:E.console.info('Start response with name "'+e.id+'" and status "'+e.status+'"',e.content),this._fireEndAction(e)}},e.prototype._createResponse=function(t){var n=this,o=function(e){E.console.error(e),n._adapter.send({id:t.id,type:2,status:1,content:String(e)})};if(this._requestHandlers[String(t.name)])try{var r=this._requestHandlers[String(t.name)](t.data);e._isPromise(r)?r.then((function(e){n._adapter.send({id:t.id,type:2,status:0,content:e})}),o):this._adapter.send({id:t.id,type:2,status:0,content:r})}catch(i){o(i)}else o(new Error('Has no handler for "'+String(t.name)+'" action!'))},e.prototype._fireEndAction=function(e){if(this._activeRequestHash[e.id]){switch(e.status){case 1:this._activeRequestHash[e.id].reject(e.content);break;case 0:this._activeRequestHash[e.id].resolve(e.content)}delete this._activeRequestHash[e.id]}},e.prototype._fireEvent=function(e,t){this._eventHandlers[e]&&(this._eventHandlers[e]=this._eventHandlers[e].slice().filter((function(e){try{e.handler.call(e.context,t)}catch(n){E.console.warn(n)}return!e.once})),this._eventHandlers[e].length||delete this._eventHandlers[e])},e._createEvent=function(e,t){return{type:0,name:e,data:t}},e._isPromise=function(e){return e&&e.then&&"function"==typeof e.then},e}();t.Bus=r})),O=function(){},P=Object.defineProperty({Adapter:O},"__esModule",{value:!0}),L=n((function(e,t){var n,o;e.exports=(n={660:(e,t)=>{t.__esModule=!0,t.EventEmitter=void 0;var n=function(){function e(e){this._events=Object.create(null),this.catchHandler=e||function(){}}return e.prototype.hasListeners=function(e){return!(!this._events[e]||!this._events[e].length)},e.prototype.getActiveEvents=function(){var e=this;return Object.keys(this._events).filter((function(t){return e.hasListeners(t)}))},e.prototype.trigger=function(e,t){var n=this;this._events[e]&&(this._events[e].slice().forEach((function(o){try{o.handler.call(o.context,t)}catch(r){n.catchHandler(r)}o.once&&n.off(e,o.handler)})),this._events[e].length||delete this._events[e])},e.prototype.on=function(e,t,n){this._on(e,t,n,!1)},e.prototype.once=function(e,t,n){this._on(e,t,n,!0)},e.prototype.off=function(e,t){var n=this,o="string"==typeof e?e:null,r="function"==typeof t?t:"function"==typeof e?e:null;if(o)if(r){if(o in this._events){var i=this._events[o].map((function(e){return e.handler})).indexOf(r);this._events[o].splice(i,1)}}else delete this._events[o];else Object.keys(this._events).forEach((function(e){n.off(e,r)}))},e.prototype._on=function(e,t,n,o){this._events[e]||(this._events[e]=[]),this._events[e].push({handler:t,context:n,once:o})},e}();t.EventEmitter=n},607:function(e,t,n){var o=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n),Object.defineProperty(e,o,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),r=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||o(t,e,n)};t.__esModule=!0;var i=n(660);r(n(660),t),t.default=i.EventEmitter}},o={},function e(t){if(o[t])return o[t].exports;var r=o[t]={exports:{}};return n[t].call(r.exports,r,r.exports,e),r.exports}(607))})),x=n((function(e,n){var o,r=t&&t.__extends||(o=function(e,t){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)},function(e,t){function n(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});Object.defineProperty(n,"__esModule",{value:!0});var i=function(e){function t(n,o){var r=e.call(this)||this;return r.win=n,r.type=o,r.handler=function(e){r.trigger("message",e)},o===t.PROTOCOL_TYPES.LISTEN&&r.win.addEventListener("message",r.handler,!1),r}var n;return r(t,e),t.prototype.dispatch=function(e){return this.win.postMessage(e,"*"),this},t.prototype.destroy=function(){this.type===t.PROTOCOL_TYPES.LISTEN&&this.win.removeEventListener("message",this.handler,!1),this.win=t._fakeWin},t._fakeWin={postMessage:n=function(){return null},addEventListener:n,removeEventListener:n},t}(L.EventEmitter);n.WindowProtocol=i,(i=n.WindowProtocol||(n.WindowProtocol={})).PROTOCOL_TYPES={LISTEN:"listen",DISPATCH:"dispatch"},n.WindowProtocol=i})),S=t&&t.__extends||(v=function(e,t){return(v=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)},function(e,t){function n(){this.constructor=e}v(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),j=t&&t.__assign||function(){return(j=Object.assign||function(e){for(var t,n=1,o=arguments.length;n<o;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)},C={origins:[],availableChanelId:[]},H=function(e){function t(n,o,r){var i=e.call(this)||this;return i.id=I.uniqueId("wa"),i.callbacks=[],i.options=t.prepareOptions(r),i.listen=n,i.dispatch=o,i.listen.forEach((function(e){return e.on("message",i.onMessage,i)})),i}return S(t,e),t.prototype.addListener=function(e){return this.callbacks.push(e),I.console.info("WindowAdapter: Add iframe message listener"),this},t.prototype.send=function(e){var t=j({},e,{chanelId:this.options.chanelId});return this.dispatch.forEach((function(e){return e.dispatch(t)})),I.console.info("WindowAdapter: Send message",t),this},t.prototype.destroy=function(){this.listen.forEach((function(e){return e.destroy()})),this.dispatch.forEach((function(e){return e.destroy()})),I.console.info("WindowAdapter: Destroy")},t.prototype.onMessage=function(e){this.accessEvent(e)&&this.callbacks.forEach((function(t){try{t(e.data)}catch(n){I.console.warn("WindowAdapter: Unhandled exception!",n)}}))},t.prototype.accessEvent=function(e){if("object"!=typeof e.data||null==e.data.type)return I.console.info("WindowAdapter: Block event. Wrong event format!",e.data),!1;if(!this.options.origins.has("*")&&!this.options.origins.has(e.origin))return I.console.info('SimpleWindowAdapter: Block event by origin "'+e.origin+'"'),!1;if(!this.options.availableChanelId.size)return!0;var t=!(!e.data.chanelId||!this.options.availableChanelId.has(e.data.chanelId));return t||I.console.info('SimpleWindowAdapter: Block event by chanel id "'+e.data.chanelId+'"'),t},t.createSimpleWindowAdapter=function(e,n){var o=this,r=this.getContentOrigin(e),i=this.prepareOptions(n),s=[];r&&i.origins.add(r);var a=new x.WindowProtocol(window,x.WindowProtocol.PROTOCOL_TYPES.LISTEN),c=function(e){s.push(e)};return a.on("message",c),this.getIframeContent(e).then((function(e){var n=new x.WindowProtocol(e.win,x.WindowProtocol.PROTOCOL_TYPES.DISPATCH),r=new t([a],[n],o.unPrepareOptions(i));return s.forEach((function(e){r.onMessage(e)})),a.off("message",c),r}))},t.prepareOptions=function(e){void 0===e&&(e=C);var t=function(e,t){return u.pipe(I.toArray,(n=t,function(e){return e.reduce((function(e,t){return e.add(t)}),n)}))(e);var n},n=t(e.origins||[],new I.UniqPrimitiveCollection([window.location.origin])),o=t(e.availableChanelId||[],new I.UniqPrimitiveCollection);return j({},e,{origins:n,availableChanelId:o})},t.unPrepareOptions=function(e){return{origins:e.origins.toArray(),availableChanelId:e.availableChanelId.toArray(),chanelId:e.chanelId}},t.getIframeContent=function(e){return e?e instanceof HTMLIFrameElement?e.contentWindow?Promise.resolve({win:e.contentWindow}):new Promise((function(t,n){e.addEventListener("load",(function(){return t({win:e.contentWindow})}),!1),e.addEventListener("error",n,!1)})):Promise.resolve({win:e}):Promise.resolve({win:window.opener||window.parent})},t.getContentOrigin=function(e){if(!e)try{return new URL(document.referrer).origin}catch(t){return null}if(!(e instanceof HTMLIFrameElement))try{return window.top.origin}catch(t){return null}try{return new URL(e.src).origin||null}catch(t){return null}},t}(P.Adapter),R=Object.defineProperty({WindowAdapter:H},"__esModule",{value:!0}),I=n((function(e,t){function n(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}Object.defineProperty(t,"__esModule",{value:!0}),n(b),n(P),n(R),n(x),n(h),n(E)}));class q{constructor(e){this._actions=[],this._maxLength=e}get length(){return this._actions.length+(null==this._active?0:1)}push(e){if(this._actions.length>=this._maxLength)throw new Error("Cant't push action! Queue is full!");return new Promise(((t,n)=>{const o=()=>{this._active=void 0;const e=this._actions.map((e=>e.action)).indexOf(r);-1!==e&&this._actions.splice(e,1),this.run()},r=()=>e().then((e=>{o(),t(e)}),(e=>{o(),n(e)}));this._actions.push({action:r,reject:n}),1===this.length&&this.run()}))}clear(e){const t="string"==typeof(e=e||new Error("Rejection with clear queue!"))?new Error(e):e;this._actions.splice(0,this._actions.length).forEach((e=>e.reject(t))),this._active=void 0}canPush(){return this._actions.length<this._maxLength}run(){const e=this._actions.shift();null!=e&&(this._active=e.action())}}const T=class extends class{constructor(e){this._events=[],this._toRunEvents=[],this._queue=new q(e)}dropConnection(){this._queue.clear(new Error("User rejection!")),this._events.forEach((e=>this._toRunEvents.push(e))),this._dropTransportConnect()}sendEvent(e){this._events.push(e),this._toRunEvents.push(e)}dialog(e){return this._runBeforeShow(),this._getBus().then((t=>{const n=this._wrapAction((()=>e(t)));return this._runEvents(t),this._queue.canPush()?this._queue.push(n).then((e=>(this._runAfterShow(),e))).catch((e=>(this._runAfterShow(),Promise.reject(e)))):Promise.reject(new Error("Queue is full!"))}))}_runBeforeShow(){0===this._queue.length&&this._beforeShow()}_runAfterShow(){0===this._queue.length&&this._afterShow()}_runEvents(e){this._toRunEvents.splice(0,this._events.length).forEach((t=>t(e)))}_wrapAction(e){return this._toRunEvents?()=>{const t=e();return t.catch((()=>{this._events.forEach((e=>this._toRunEvents.push(e)))})),t}:e}}{constructor(e,t){super(t),this._url=e,this._initIframe()}get(){return this._iframe||this._initIframe(),this._iframe}_dropTransportConnect(){null!=this._iframe&&(document.body.removeChild(this._iframe),this._initIframe()),this._bus&&(this._bus.destroy(),this._bus=void 0)}_getBus(){return this._bus?Promise.resolve(this._bus):I.WindowAdapter.createSimpleWindowAdapter(this._iframe).then((e=>new Promise((t=>{this._bus=new I.Bus(e,-1),this._bus.once("ready",(()=>{t(this._bus)}))}))))}_beforeShow(){this._showIframe()}_afterShow(){this._hideIframe()}_initIframe(){this._iframe=this._createIframe(),this._addIframeToDom(this._iframe),this._listenFetchURLError(this._iframe),this._hideIframe()}_addIframeToDom(e){null!=document.body?document.body.appendChild(e):document.addEventListener("DOMContentLoaded",(()=>{document.body.appendChild(e)}))}_createIframe(){const e=document.createElement("iframe");return e.style.transition="opacity .2s",e.style.position="absolute",e.style.opacity="0",e.style.width="100%",e.style.height="100%",e.style.left="0",e.style.top="0",e.style.border="none",e.style.position="fixed",e}_showIframe(){this._applyStyle({width:"100%",height:"100%",left:"0",top:"0",border:"none",position:"fixed",display:"block",opacity:"0",zIndex:"99999999"}),null!=T._timer&&clearTimeout(T._timer),T._timer=setTimeout((()=>{this._applyStyle({opacity:"1"})}),0)}_hideIframe(){this._applyStyle({opacity:"0"}),null!=T._timer&&clearTimeout(T._timer),T._timer=setTimeout((()=>{this._applyStyle({width:"10px",height:"10px",left:"-100px",top:"-100px",position:"absolute",opacity:"0",zIndex:"0",display:"none"})}),200)}_applyStyle(e){Object.entries(e).forEach((([e,t])=>{null!=t&&this._iframe&&(this._iframe.style[e]=t)}))}_renderErrorPage(e,t,n){e.parentElement&&(e.parentElement.style.height="100%"),Object.assign(e.style,{position:"relative",boxSizing:"border-box",width:"100%",height:"100%",display:"flex",justifyContent:"center",alignItems:"center",margin:"0px"});const o=document.createElement("div");Object.assign(o.style,{position:"fixed",zIndex:"-1",height:"100%",width:"100%",overflow:"hidden",backgroundColor:"#000",opacity:"0.6"});const r=document.createElement("div");Object.assign(r.style,{position:"fixed",display:"flex",justifyContent:"center",alignItems:"center",flexDirection:"column",margin:"0",backgroundColor:"#292F3C",width:"520px",borderRadius:"6px",padding:"40px",boxSizing:"border-box"});const i=document.createElement("div");i.textContent=n,Object.assign(i.style,{fontSize:"15px",lineHeight:"20px",color:"#fff",marginBottom:"40px",fontFamily:"Roboto, sans-serif"});const s=document.createElement("button");s.textContent="OK",s.addEventListener("click",(()=>t())),Object.assign(s.style,{width:"100%",fontSize:"15px",lineHeight:"48px",padding:" 0 40px",color:"#fff",backgroundColor:"#5A81EA",outline:"none",border:"none",cursor:"pointer",fontFamily:"Roboto, sans-serif",borderRadius:"4px"}),r.appendChild(i),r.appendChild(s),e.appendChild(o),e.appendChild(r)}_listenFetchURLError(e){fetch(this._url).catch((()=>{e.addEventListener("load",(()=>{e.contentDocument&&(this._renderErrorPage(e.contentDocument.body,(()=>this.dropConnection()),"The request could not be processed. To resume your further work, disable the installed plugins."),this._showIframe())}))}))}};let A=T;A._timer=null;class W{constructor(e,t){this.user=null,this.emitter=new L.EventEmitter,this._clientUrl=(e||"https://waves.exchange/signer/")+`?${W._getCacheClean()}`,this._transport=new A(this._clientUrl,3),!0===t&&(I.config.console.logLevel=I.config.console.LOG_LEVEL.VERBOSE)}static _getCacheClean(){return String(Date.now()%6e4)}on(e,t){return this.emitter.on(e,t),this}once(e,t){return this.emitter.once(e,t),this}off(e,t){return this.emitter.once(e,t),this}connect(e){return Promise.resolve(this._transport.sendEvent((t=>t.dispatchEvent("connect",e))))}logout(){return this.user=null,Promise.resolve(this._transport.dropConnection())}login(){var e;if(this.user)return Promise.resolve(this.user);const t=this._transport.get();if(function(){const e=navigator.userAgent.toLowerCase(),t=e.includes("safari")&&!e.includes("chrome");return null!=navigator.platform&&/iPad|iPhone|iPod/.test(navigator.platform)||t}()){if(!(null==(e=t.contentWindow)?void 0:e.open(this._clientUrl)))throw new Error("Window was blocked")}return t.src=this._clientUrl,this._transport.dialog((e=>e.request("login").then((e=>(this.user=e,e))).catch((e=>(this._transport.dropConnection(),Promise.reject(e))))))}signMessage(e){return this.login().then((()=>this._transport.dialog((t=>t.request("sign-message",e)))))}signTypedData(e){return this.login().then((()=>this._transport.dialog((t=>t.request("sign-typed-data",e)))))}sign(e){return this.login().then((()=>this._transport.dialog((t=>t.request("sign",e)))))}}e.ProviderWeb=W,Object.defineProperty(e,"__esModule",{value:!0}),e[Symbol.toStringTag]="Module"}));
